<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Events</title>
<style>
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif}
  .status{padding:10px 12px;border-radius:10px;background:#f3f4f6;margin-bottom:12px;word-break:break-all}

  /* 照片牆：固定約 2/3 高度，但「牆內可捲動」→ 不會只剩第一列 */
  .g{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    max-height:66vh;
    overflow:auto;                 /* ← 這行是關鍵：改 auto，不用 hidden */
    -webkit-overflow-scrolling:touch;
    padding-right:6px;             /* 避免捲軸壓到圖 */
  }
  .g a{display:block}
  .g img{width:100%;height:auto;display:block;background:#eee;cursor:zoom-in}
  @media(max-width:900px){.g{grid-template-columns:repeat(2,1fr)}}

  .lb{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.86);z-index:9999}
  .lb.on{display:flex}
  .lb img{max-width:96vw;max-height:96vh;object-fit:contain;background:#111}
  .hint{font-size:12px;opacity:.8;margin-top:6px}
</style>
</head>
<body>

<div id="status" class="status">載入中…</div>
<div id="gallery" class="g"></div>

<div id="lb" class="lb" aria-hidden="true">
  <img id="big" alt="">
</div>

<script>
(() => {
  const owner = "worldjournal";
  const repo  = "Events";

  const statusEl = document.getElementById("status");
  const G  = document.getElementById("gallery");
  const LB = document.getElementById("lb");
  const BIG= document.getElementById("big");

  const openLB = (url) => { BIG.src = url; LB.classList.add("on"); };
  const closeLB = () => { LB.classList.remove("on"); BIG.src = ""; };
  LB.onclick = (e) => { if (e.target === LB) closeLB(); };
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLB(); });

  const api = (path) => `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

  async function tryList(label, apiPath) {
    const r = await fetch(api(apiPath), { cache: "no-store" });
    let j=null; try{ j=await r.json(); }catch{}
    return { ok:r.ok, status:r.status, json:j, label };
  }

  function render(files, folderLabel) {
    const imgs = files
      .filter(f => f && f.type==="file" && /\.(jpe?g|png|webp|gif)$/i.test(f.name))
      .sort((a,b)=>a.name.localeCompare(b.name, "zh-Hant"));

    if (!imgs.length){
      statusEl.textContent = `找到資料夾「${folderLabel}」，但裡面沒有圖片檔（jpg/png/webp/gif）。`;
      return;
    }

    statusEl.innerHTML = `已載入 ${imgs.length} 張（資料夾：${folderLabel}）<div class="hint">照片牆可在框內捲動；點圖放大；Esc / 點黑底關閉。</div>`;

    const frag=document.createDocumentFragment();
    imgs.forEach(f=>{
      const a=document.createElement("a");
      a.href=f.download_url;
      a.onclick=(e)=>{ e.preventDefault(); openLB(f.download_url); };

      const img=new Image();
      img.loading="lazy";
      img.src=f.download_url;
      img.alt=f.name;

      a.appendChild(img);
      frag.appendChild(a);
    });
    G.replaceChildren(frag);
  }

  (async ()=>{
    const r1 = await tryList("img", "img");
    if (r1.ok && Array.isArray(r1.json)) { render(r1.json, "img"); return; }

    const r2 = await tryList("img␠", "img%20");
    if (r2.ok && Array.isArray(r2.json)) { render(r2.json, "img␠"); return; }

    const m1 = (r1.json && r1.json.message) ? `；${r1.json.message}` : "";
    const m2 = (r2.json && r2.json.message) ? `；${r2.json.message}` : "";
    statusEl.textContent = `載入失敗：img HTTP ${r1.status}${m1} | img␠ HTTP ${r2.status}${m2}`;
  })();
})();
</script>

</body>
</html>
