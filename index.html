<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Events</title>
<style>
  body{margin:0;padding:14px;font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif}
  .status{padding:10px 12px;border-radius:10px;background:#f3f4f6;margin-bottom:12px;word-break:break-all}

  /* 照片牆：固定約 2/3 高度，牆內捲動 */
  .g{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    height:66vh;             /* 用 height 不是 max-height，避免只露第一列 */
    overflow-y:auto;
    overflow-x:hidden;
    align-content:start;
    padding-right:6px;        /* 避免捲軸壓到圖 */
    -webkit-overflow-scrolling:touch;
  }
  .g a{display:block}
  .g img{width:100%;height:auto;display:block;background:#eee;cursor:zoom-in}
  @media(max-width:900px){.g{grid-template-columns:repeat(2,1fr)}}

  /* 燈箱 */
  .lb{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.86);z-index:9999}
  .lb.on{display:flex}
  .lb img{max-width:96vw;max-height:96vh;object-fit:contain;background:#111}
  .hint{font-size:12px;opacity:.8;margin-top:6px}
</style>
</head>
<body>

<div id="status" class="status">載入中…</div>
<div id="gallery" class="g" tabindex="0" aria-label="Photos"></div>

<div id="lb" class="lb" aria-hidden="true"><img id="big" alt=""></div>

<script>
(() => {
  const owner="worldjournal";
  const repo="Events";
  const statusEl=document.getElementById("status");
  const G=document.getElementById("gallery");
  const LB=document.getElementById("lb");
  const BIG=document.getElementById("big");

  const openLB=(url)=>{ BIG.src=url; LB.classList.add("on"); };
  const closeLB=()=>{ LB.classList.remove("on"); BIG.src=""; };
  LB.onclick=e=>{ if(e.target===LB) closeLB(); };
  document.addEventListener("keydown",e=>{ if(e.key==="Escape") closeLB(); });

  const apiRepo = `https://api.github.com/repos/${owner}/${repo}`;

  // 把路徑每一段各自 encode，保留斜線
  const encodePath = (p) => p.split("/").map(encodeURIComponent).join("/");

  async function getDefaultBranch(){
    const r = await fetch(apiRepo, {cache:"no-store"});
    if(!r.ok) throw new Error(`Repo API HTTP ${r.status}`);
    const j = await r.json();
    return j.default_branch;
  }

  async function getTree(branch){
    const r1 = await fetch(`${apiRepo}/git/refs/heads/${encodeURIComponent(branch)}`, {cache:"no-store"});
    if(!r1.ok) throw new Error(`Ref HTTP ${r1.status}`);
    const ref = await r1.json();
    const sha = ref.object && ref.object.sha;
    if(!sha) throw new Error("No ref sha");

    const r2 = await fetch(`${apiRepo}/git/trees/${sha}?recursive=1`, {cache:"no-store"});
    if(!r2.ok) throw new Error(`Tree HTTP ${r2.status}`);
    const tree = await r2.json();
    if(!tree.tree) throw new Error("No tree");
    return tree.tree;
  }

  function isImgPath(path){
    // 支援 img/ 與 img␠/，也支援底下子資料夾
    return /^(img|img )\/.+\.(jpe?g|png|webp|gif)$/i.test(path);
  }

  function rawUrl(branch, path){
    return `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${encodePath(path)}`;
  }

  function render(branch, paths){
    statusEl.innerHTML = `已載入 ${paths.length} 張（來源：${branch}）<div class="hint">照片牆區塊內可捲動；點圖放大；Esc / 點黑底關閉。</div>`;
    const frag=document.createDocumentFragment();
    paths.forEach(p=>{
      const url = rawUrl(branch, p);
      const a=document.createElement("a");
      a.href=url;
      a.onclick=(e)=>{ e.preventDefault(); openLB(url); };

      const img=new Image();
      img.loading="lazy";
      img.src=url;
      img.alt=p.split("/").pop() || "";

      a.appendChild(img);
      frag.appendChild(a);
    });
    G.replaceChildren(frag);
  }

  (async ()=>{
    try{
      const branch = await getDefaultBranch();
      const tree = await getTree(branch);

      const paths = tree
        .filter(n=>n && n.type==="blob" && n.path && isImgPath(n.path))
        .map(n=>n.path)
        .sort((a,b)=>a.localeCompare(b, "zh-Hant"));

      if(paths.length===0){
        statusEl.textContent = "找不到任何 img/（或 img␠/）底下的圖片檔。";
        return;
      }
      render(branch, paths);
    }catch(err){
      statusEl.textContent = "載入失敗：" + (err && err.message ? err.message : String(err));
    }
  })();
})();
</script>

</body>
</html>
